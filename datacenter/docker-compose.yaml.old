---
services:
  flask:
    build: rest
    ports:
      - "5000:5000"
    volumes:
      - ./rest/app:/src/app:ro
      - ./db:/src/db:rw
    networks:
      - iot_datacenter
      - backend

  web:
    build: web
    ports:
      - "5001:5000"
    volumes:
      - ./web/app:/src/app:ro
      - ./db:/src/db:ro
    networks:
      - frontend

  rabbit:
    image: rabbitmq:3
    restart: always
    ports:
      - "5672:5672"
    networks:
      - amqp
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      timeout: 10s
      interval: 30s
      retries: 3

  amqp-bridge:
    build: amqp-bridge
    restart: always
    environment:
      AMQP_SERVER: rabbit
    volumes:
      - ./bridge-amqp/src/app:/app:ro
    networks:
      - amqp
      - backend
    depends_on:
      rabbit:
        condition: service_healthy

  #
  # db:
  #   image: mariadb
  #   restart: always
  #   environment:
  #     MARIADB_ROOT_PASSWORD: my-secret-pw
  #     # MARIADB_MYSQL_LOCALHOST_USER: 1
  #     MARIADB_USER: user
  #     MARIADB_PASSWORD: user
  #     MARIADB_DATABASE: colis
  #   networks:
  #     - db
  #
  # adminer:
  #   image: adminer
  #   restart: always
  #   ports:
  #   - "8080:8080"



networks:
  iot_datacenter:
    external: true
  frontend:
  backend:
  amqp:
